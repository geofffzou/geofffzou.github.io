<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>SVG to GPX</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { font-family: Arial; padding: 20px; }
#map { width: 600px; height: 400px; border: 2px solid black; }
</style>
</head>
<body>

<h2>Upload SVG Route â†’ GPX</h2>

<input type="file" id="upload" accept=".svg">
<button onclick="exportGPX()">Export GPX</button>

<br><br>
<div id="map"></div>

<script>
const map = L.map('map').setView([37.7749, -122.4194], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
 attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let gpsTrack = [];
let imageBounds;

document.getElementById("upload").addEventListener("change", function(e){
 const file = e.target.files[0];
 const reader = new FileReader();

 reader.onload = function(event){
   const parser = new DOMParser();
   const svgDoc = parser.parseFromString(event.target.result, "image/svg+xml");
   const path = svgDoc.querySelector("path");

   if(!path){
     alert("No path found in SVG");
     return;
   }

   const svgElement = svgDoc.querySelector("svg");
   const width = parseFloat(svgElement.getAttribute("width")) || 1000;
   const height = parseFloat(svgElement.getAttribute("height")) || 1000;

   imageBounds = map.getBounds();

   const totalLength = path.getTotalLength();
   gpsTrack = [];

   for(let i=0; i<=totalLength; i+=5){
     const pt = path.getPointAtLength(i);

     const west = imageBounds.getWest();
     const east = imageBounds.getEast();
     const north = imageBounds.getNorth();
     const south = imageBounds.getSouth();

     const lng = west + (pt.x / width) * (east - west);
     const lat = north - (pt.y / height) * (north - south);

     gpsTrack.push([lat, lng]);
   }

   gpsTrack = simplifyDouglasPeucker(gpsTrack, 0.00005);

   L.polyline(gpsTrack, {color:'red'}).addTo(map);

   alert("Track generated from SVG!");
 };

 reader.readAsText(file);
});

function simplifyDouglasPeucker(points, tolerance){
 if(points.length <= 2) return points;

 const sqTolerance = tolerance * tolerance;

 function getSqSegDist(p, p1, p2){
   let x = p1[1], y = p1[0];
   let dx = p2[1]-x, dy = p2[0]-y;

   if(dx!==0 || dy!==0){
     let t = ((p[1]-x)*dx + (p[0]-y)*dy)/(dx*dx+dy*dy);
     if(t>1){ x=p2[1]; y=p2[0]; }
     else if(t>0){ x+=dx*t; y+=dy*t; }
   }

   dx = p[1]-x; dy = p[0]-y;
   return dx*dx + dy*dy;
 }

 function simplifyDP(points, first, last, simplified){
   let maxDist = sqTolerance, index;

   for(let i=first+1; i<last; i++){
     const dist = getSqSegDist(points[i], points[first], points[last]);
     if(dist > maxDist){
       index = i;
       maxDist = dist;
     }
   }

   if(maxDist > sqTolerance){
     if(index-first>1) simplifyDP(points, first, index, simplified);
     simplified.push(points[index]);
     if(last-index>1) simplifyDP(points, index, last, simplified);
   }
 }

 const simplified = [points[0]];
 simplifyDP(points, 0, points.length-1, simplified);
 simplified.push(points[points.length-1]);

 return simplified;
}

function exportGPX(){
 if(!gpsTrack.length) return;

 let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="SVGTool">
<trk><name>SVG Route</name><trkseg>`;

 gpsTrack.forEach(pt=>{
   gpx += `<trkpt lat="${pt[0]}" lon="${pt[1]}"></trkpt>`;
 });

 gpx += `</trkseg></trk></gpx>`;

 const blob = new Blob([gpx], {type:"application/gpx+xml"});
 const url = URL.createObjectURL(blob);

 const a = document.createElement("a");
 a.href = url;
 a.download = "route.gpx";
 a.click();
}
</script>
</body>
</html>
